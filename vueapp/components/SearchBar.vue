<template>
    <div class="oc--searchbar">
        <ul class="oc--searchbar-container">
            <li class="oc--searchbar-token" v-for="token in searchTokens" v-bind:key="token">
                <span>{{ token.type_name }}</span>
                <span>{{ token.compare }}</span>
                <span class="oc--shorten-token">{{ token.value_name }}</span>
                <studip-icon
                    shape="decline" role="clickable" class="oc--remove-filter"
                    @click="removeToken(token)"
                    @blur="delayedHideTokenSelector"
                />
            </li>
            <li class="oc--searchbar-token" v-if="token && token.type">
                <span>{{ token.type_name }}</span>
                <span>{{ token.compare }}</span>
                <span class="oc--shorten-token">{{ token.value_name }}</span>
                <studip-icon
                    shape="decline" role="clickable" class="oc--remove-filter"
                    @click="removeTokenSelect"
                    @blur="delayedHideTokenSelector"
                />
            </li>
            <li class="oc--searchbar--input">
                <input type="text" ref="searchbar"
                    v-on:keyup="hideTokenSelector"
                    v-on:keyup.enter="doSearch"
                    v-model="inputSearch" placeholder="Suche..."
                    @focus="showTokenSelector"
                    @click="showTokenSelector"
                    @blur="delayedHideTokenSelector"
                    @submit="doSearch"
                />
            </li>
            <li title="Suche starten"
                class="oc--searchbar--search-icon"
                @click="doSearch"
            >
                <studip-icon
                    shape="search" role="clickable"
                />
            </li>
        </ul>

        <div class="oc--tokenselector" v-if="showTS"
            :style="`left:` + tokenSelectorPos.left + `px; top:` + tokenSelectorPos.top + `px;`"
        >
            <ul v-if="tokenState == 'main'">
                <li @click="selectToken('tag')" :class="{
                    'oc--tokenselector--disabled-option': !filteredTags.length
                }">
                    {{ $gettext('Schlagwort') }}
                </li>

                <li @click="selectToken('playlist')" :class="{
                    'oc--tokenselector--disabled-option': !playlists || !comparablePlaylists.length
                }">
                    {{ $gettext('Wiedergabeliste') }}
                </li>
            </ul>

            <ul v-if="tokenState == 'compare'" class="oc--tokenselector--comparison">
                <li @click="selectToken('=')">
                    gleich
                    <span>=</span>
                </li>
                <li @click="selectToken('!=')">
                    ungleich
                    <span>!=</span>
                </li>
            </ul>

            <ul v-if="tokenState == 'value' && token.type == 'tag'">
                <li v-for="(tag, index) in filteredTags" v-bind:key="index" @click="selectToken(tag)">
                    {{ tag }}
                </li>
            </ul>

            <ul v-if="tokenState == 'value' && token.type == 'playlist'">
                <li v-for="playlist in comparablePlaylists" v-bind:key="playlist.token" @click="selectToken(playlist)">
                    {{ playlist.title }}
                </li>
            </ul>
        </div>
    </div>
</template>

<script>
import { mapGetters } from 'vuex'
import StudipIcon from '@studip/StudipIcon'

export default {
    name: "SearchBar",

    components: {
        StudipIcon
    },

    data() {
        return {
            inputSearch: '',
            searchTokens: [],
            showTS: false,
            tokenState: 'main',
            token: null,
            tokenSelectorPos: {
                top: 0,
                left: 0
            }        }
    },

    computed: {
        ...mapGetters([
            'videoSort',
            'availableVideoTags',
            'playlists',
            'playlist'
        ]),

        filteredTags() {
            let filteredTags = [];

            for (let i = 0; i < this.availableVideoTags.length; i++) {
                if (!this.searchTokens.find(token => token.value == this.availableVideoTags[i])) {
                    filteredTags.push(this.availableVideoTags[i]);
                }
            }
            return filteredTags;
        },

        comparablePlaylists() {
            if (this.playlist) {
                return this.playlists.filter(playlist => playlist.token != this.playlist.token);
            }
            return this.playlists;
        },
    },

    methods: {
        showTokenSelector() {
            this.showTS = true;

            if (this.token == null) {
                this.token = {
                    type_name: null,
                    value_name: null,
                    type:       null,
                    compare:    null,
                    value:      null
                }
            }

            this.tokenSelectorPos.top = this.$refs.searchbar.offsetTop + 30;
            this.tokenSelectorPos.left = this.$refs.searchbar.offsetLeft;
        },

        // this is done in order to avoid hiding (and therefore deactivating the token selector)
        // before the click-events of the token selector had a chance to fire
        delayedHideTokenSelector() {
            let view = this;

            window.setTimeout(() => {
                if (view.token.type == null) {
                    view.hideTokenSelector();
                }
            }, 200);
        },

        hideTokenSelector() {
            this.showTS = false;
        },

        selectToken(content) {
            if (this.tokenState == 'main')
            {
                if (content == 'tag' && this.filteredTags.length) {
                    this.token.type      = 'tag';
                    this.token.type_name = this.$gettext('Schlagwort')
                    this.tokenState      = 'compare';

                } else if (content == 'playlist' && this.playlists && this.comparablePlaylists.length) {
                    this.token.type      = 'playlist';
                    this.token.type_name = this.$gettext('Wiedergabeliste')
                    this.tokenState      = 'compare';
                }

            } else if (this.tokenState == 'compare')
            {
                this.token.compare = content;
                this.tokenState    = 'value';

            } else if (this.tokenState == 'value')
            {
                if (this.token.type == 'tag') {
                    this.token.value      = content;
                    this.token.value_name = content;
                } else if (this.token.type == 'playlist') {
                    this.token.value      = content.token;
                    this.token.value_name = content.title;
                }
                this.tokenState       = 'main';

                this.searchTokens.push(this.token);
                this.token = null;

                this.hideTokenSelector();
                this.doSearch();
            }

        },

        removeToken(token) {
            this.searchTokens.splice(this.searchTokens.indexOf(token), 1);
            this.doSearch();
        },

        removeTokenSelect() {
            this.token = null;
            this.tokenState = 'main';
            this.hideTokenSelector();
        },

        doSearch() {
            let filters = JSON.parse(JSON.stringify(this.searchTokens));

            if (this.inputSearch) {
                filters.push({
                    type: 'text',
                    value: this.inputSearch
                });
            }

            this.$emit('search', {
                filters: filters,
            });
        },
    },

    updated() {
        if (this.showTS) {
            this.showTokenSelector();
        }
    },
}
</script>